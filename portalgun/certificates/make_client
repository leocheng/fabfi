#!/bin/bash

echo "Enter client shortname, e.g tom "
read client_name

echo "Enter client email address- This will be used as the client ID e.g tom@fabfi.net "
read client_email

echo "Enter Client key password - This will be the password to your private key"
read client_password

if [ -f ${client_name}.crt ]; then
	echo "Erasing old config"
	rm -f ${client_name}.key
	rm -f ${client_name}.csr
	rm -f ${client_name}.cnf
fi

if [ ! -f index.txt ]; then
	touch index.txt
fi

if [ ! -f serial ]; then
        echo 01 > serial
fi

printf "[ ca ]\ndefault_ca		= CA_default\n\n[ CA_default ]\ndir			= ./\ncerts			= \$dir\ncrl_dir			= \$dir/crl\ndatabase		= \$dir/index.txt\nnew_certs_dir		= \$dir\ncertificate		= \$dir/server.pem\nserial			= \$dir/serial\ncrl			= \$dir/crl.pem\nprivate_key		= \$dir/server.key\nRANDFILE		= \$dir/.rand\nname_opt		= ca_default\ncert_opt		= ca_default\ndefault_days		= 365\ndefault_crl_days	= 30\ndefault_md		= md5\npreserve		= no\npolicy			= policy_match\n\n[ policy_match ]\ncountryName		= match\nstateOrProvinceName	= match\norganizationName	= match\norganizationalUnitName	= optional\ncommonName		= supplied\nemailAddress		= optional\n\n[ policy_anything ]\ncountryName		= optional\nstateOrProvinceName	= optional\nlocalityName		= optional\norganizationName	= optional\norganizationalUnitName	= optional\ncommonName		= supplied\nemailAddress		= optional\n\n[ req ]\nprompt			= no\ndistinguished_name	= ${client_name}\ndefault_bits		= 2048\ninput_password		= ${client_password}\noutput_password		= ${client_password}\n\n[${client_name}]\ncountryName		= US\nstateOrProvinceName	= Massachusetts\nlocalityName		= Cambridge\norganizationName	= FabFi\nemailAddress		= ${client_email}\ncommonName		= ${client_email}" >> ${client_name}.cnf

echo "Generating .csr and .key files"

openssl req -new  -out ${client_name}.csr -keyout ${client_name}.key -config ./${client_name}.cnf


echo "Generating .crt - Certificate file "

if [ ! -f ${client_name}.crt ]; then

	echo "What is your CA key password?"
	read ca_password

	openssl ca -batch -keyfile ca.key -cert ca.pem -in ${client_name}.csr  -key ${ca_password} -out ${client_name}.crt -extensions xpclient_ext -extfile xpextensions -config ./${client_name}.cnf

	if [ -f ${client_name}.crt ]; then

		echo "Generating P12"

		openssl pkcs12 -export -in ${client_name}.crt -inkey ${client_name}.key -out ${client_name}.p12  -passin pass:${client_password} -passout pass:${client_password}

		echo "Generating PEM"
		openssl pkcs12 -in ${client_name}.p12 -out ${client_name}.pem -passin pass:${client_password} -passout pass:${client_password}
	

		printf "\nVerifying created certificate\n\n"

		check=$(openssl verify -CAfile ca.pem ${client_name}.pem |  grep OK | awk -F ": " '{print $2}')
	
		if [ ${check} == "OK" ]; then
			rm ${client_name}.cnf
			echo "Certificate ok"
			mkdir dir_${client_name}
			mv ${client_name}* dir_${client_name}/
			echo "Certificates stored in dir_${client_name} directory"

		else 
	
			echo "Invalid certificate"
			rm ${client_name}*
		fi
	else
		echo "Something went wrong, ( you probably entered a wrong CA password )"
	fi
else
	echo "Doing nothing - you already have a certificate"
fi
